name: Auto Update Surge Rules

on:
  schedule:
    - cron: '0 0 * * *' # 每天北京时间上午 8 点自动执行
  workflow_dispatch:   # 允许你手动点击 "Run workflow" 立即更新

jobs:
  update-rules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Requests
        run: pip install requests

      - name: Fetch, Clean and Save Rules
        shell: python
        run: |
          import requests
          import os

          # 1. 配置
          url = "https://raw.githubusercontent.com/Accademia/Additional_Rule_For_Clash/refs/heads/main/ChinaMax/ChinaMax_No_Resolve.yaml"
          save_dir = "Surge/Rules"
          save_file = os.path.join(save_dir, "ChinaMax_No_Resolve.list")

          # 2. 下载
          try:
              print("正在下载上游文件...")
              r = requests.get(url, timeout=30)
              r.raise_for_status()
              content = r.text
          except Exception as e:
              print(f"下载失败: {e}")
              exit(1)

          # 3. 处理：去重 + 格式化 (去除YAML短杠、引号、空格)
          unique_rules = set()
          for line in content.splitlines():
              # 清理 YAML 符号并分割逗号
              clean = line.strip().lstrip('-').strip().replace("'", "").replace('"', "")
              if ',' in clean:
                  # 重新拼接: 键,值 (去除多余空格)
                  parts = [p.strip() for p in clean.split(',')]
                  if len(parts) >= 2:
                      unique_rules.add(",".join(parts))

          # 4. 写入文件
          os.makedirs(save_dir, exist_ok=True)
          with open(save_file, 'w', encoding='utf-8') as f:
              f.write("# Updated: " + "\n")
              for rule in sorted(list(unique_rules)):
                  f.write(rule + '\n')
          print(f"成功处理 {len(unique_rules)} 条规则")

      - name: Commit and Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add Surge/Rules/ChinaMax_No_Resolve.list
          git commit -m "chore: 自动更新规则" || exit 0
          git push

